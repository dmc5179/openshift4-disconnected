---
apiVersion: apps.gitlab.com/v1beta1
kind: GitLab
metadata:
  name: gitlab
  namespace: gitlab-system
spec:
  chart:
    values:
      gitlab:
        gitaly:
          persistence:
            storageClass: gp3-csi-encrypted
            size: 50Gi
        toolbox:
          backups:
            objectStorage:
              connection:
                provider: AWS
                secret: gitlab-object-storage
                key: config
              config:
                provider: AWS
                secret: gitlab-object-storage
                key: config
        https: true
        gitlab-shell:
          maxReplicas: 2
          minReplicas: 1
        sidekiq:
          maxReplicas: 2
          minReplicas: 1
          resources:
            requests:
              cpu: 500m
              memory: 1000M
        webservice:
          maxReplicas: 2
          minReplicas: 1
          resources:
            requests:
              cpu: 500m
              memory: 1500M
      gitlab-runner:
        image:
          tag: ubi-fips-v18.4.0
      global:
        minio:
          enabled: false # false when using AWS S3
        image:
          tagSuffix: "-ubi"
          #pullPolicy: Always
        appConfig:
          omniauth:
            allow_bypass_two_factor: true
            allow_single_sign_on: true
            allowSingleSignOn:
            - oauth2_generic
            enabled: true
            providers:
            - secret: gitlab-oauth2-generic
          defaultProjectsFeatures:
            issues: true
            mergeRequests: true
            wiki: true
            snippets: true
            builds: true
            containerRegistry: true
          artifacts:
            bucket: ocp-vn692-gitlab-artifacts-storage
            #proxy_download: false # set to true when using encrypted buckets?
          backups:
            bucket: ocp-vn692-gitlab-backup-storage
            tmpBucket: ocp-vn692-gitlab-tmp-storage
            #proxy_download: false # set to true when using encrypted buckets?
          ciSecureFiles:
            bucket: ocp-vn692-gitlab-ci-secure-files-storage
            enabled: true
            #proxy_download: false # set to true when using encrypted buckets?
          dependencyProxy:
            bucket: ocp-vn692-gitlab-dependency-proxy
            enabled: true
            #proxy_download: false # set to true when using encrypted buckets?
          externalDiffs:
            bucket: ocp-vn692-gitlab-external-diffs
            enabled: true
            #proxy_download: false # set to true when using encrypted buckets?
          lfs:
            bucket: ocp-vn692-gitlab-lfs-storage
            #proxy_download: false # set to true when using encrypted buckets?
          packages:
            accessControl: true
            bucket: ocp-vn692-gitlab-packages-storage
            #proxy_download: false # set to true when using encrypted buckets?
          terraformState:
            bucket: ocp-vn692-gitlab-terraform-state-storage
            enabled: true
            #proxy_download: false # set to true when using encrypted buckets?
          uploads:
            bucket: ocp-vn692-gitlab-uploads-storage
            #proxy_download: false # set to true when using encrypted buckets?
          object_store:
            connection:
              provider: AWS
              #secret: gitlab-object-storage
              #key: "config"
              secret: gitlab-s3-secrets
              key: "connection"
            enabled: true
            proxy_download: true # set to true when using encrypted buckets?
            #storage_options:
            #  server_side_encryption: aws:kms
            #  server_side_encryption_kms_key_id: "arn:aws:kms"
        pages:
          enabled: false # pages doesn't work with OCP ingress due to its own wildcard. OCP Router denies it
          #objectStore:
          #  enabled: true
          #  bucket: ocp-vn692-gitlab-pages-storage
          #  connection:
          #    provider: AWS
          #    secret: gitlab-object-storage
          #    key: "config"
        registry: 
          bucket: ocp-vn692-gitlab-registry-storage
          connection:
            provider: AWS
            secret: gitlab-object-storage
            key: "config"
        hosts:
          domain: apps.ecs.sandbox1248.opentlc.com # Part after console-openshift-console
        edition: ce
        ingress:
          #enabled: false
          class: "none"
          #class: "nginx" #set to 'none' to allow OpenShift to take over but then git over ssh is not supported
          annotations:
            route.openshift.io/termination: "edge" # For OpenShift Routes
            route.openshift.io/insecure-edge-termination-policy: "Redirect" # For OpenShift Routes
          configureCertmanager: false
          tls:
            secretName: gitlab-wildcard-tls-certs
      installCertmanager: false
      registry:
        storage:
          secret: registry-storage
          key: "config"
      #smartcard:
      #kas:
      #pages:
      #ssh:
      minio:
        #enabled: true # should be set in global.minio.enabled instead
        persistence:
          storageClass: gp3-csi-encrypted
          size: 30Gi
        resources:
          requests:
            cpu: 100m
      nginx-ingress:
        enabled: false
        #controller:
        #  electionID: ingress-controller-leader
        #  replicaCount: 1
      postgresql:
        install: true
        primary:
          persistence:
            storageClass: gp3-csi-encrypted
            size: 30Gi
          extendedConfiguration: max_connections = 200
      redis:
        install: true
        master:
          persistence:
            storageClass: gp3-csi-encrypted
            size: 5Gi
        resources:
          requests:
            cpu: 100m
      prometheus:
        install: false
    version: 9.4.2
