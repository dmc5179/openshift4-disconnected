AWSTemplateFormatVersion: 2010-09-09
Description: Template for OpenShift Cluster IAM Elements

Parameters:
  InfrastructureName:
    AllowedPattern: ^([a-zA-Z][a-zA-Z0-9\-]{0,26})$
    MaxLength: 27
    MinLength: 1
    ConstraintDescription: >-
      Infrastructure name must be alphanumeric, start with a letter, and have a maximum of 27 characters.
    Description: >-
      Prepended to the name of resources created like, openshift4-master-role, openshift4-worker-role
    Type: String
    Default: "openshift4"

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: "Cluster Information"
      Parameters:
      - InfrastructureName
    ParameterLabels:
      InfrastructureName:
        default: "Infrastructure Name"

Resources:

  MyIAMUser:
    Type: AWS::IAM::User
    Properties:
      UserName: OpenShiftInstaller
      # You can optionally attach managed policies directly to the user
      ManagedPolicyArns:
        - !Ref OpenShiftInstallerIamRole
        #- arn:aws:iam::aws:policy/openshift-installer-role
        #- !Ref OpenShiftInstallerIamRole # This is the role name and not the ARN which I think we need

  OpenShiftInstallerIamRole:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: "Allow"
          Action:
          - "ec2:AttachNetworkInterface"
          - "ec2:AuthorizeSecurityGroupEgress"
          - "ec2:AuthorizeSecurityGroupIngress"
          - "ec2:CopyImage"
          - "ec2:CreateNetworkInterface"
          - "ec2:CreateSecurityGroup"
          - "ec2:CreateTags"
          - "ec2:CreateVolume"
          - "ec2:DeleteSecurityGroup"
          - "ec2:DeleteSnapshot"
          - "ec2:DeleteTags"
          - "ec2:DeregisterImage"
          - "ec2:DescribeAccountAttributes"
          - "ec2:DescribeAddresses"
          - "ec2:DescribeAvailabilityZones"
          - "ec2:DescribeDhcpOptions"
          - "ec2:DescribeImages"
          - "ec2:DescribeInstanceAttribute"
          - "ec2:DescribeInstanceCreditSpecifications"
          - "ec2:DescribeInstances"
          - "ec2:DescribeInstanceTypes"
          - "ec2:DescribeInternetGateways"
          - "ec2:DescribeKeyPairs"
          - "ec2:DescribeNatGateways"
          - "ec2:DescribeNetworkAcls"
          - "ec2:DescribeNetworkInterfaces"
          - "ec2:DescribePrefixLists"
          #- "ec2:DescribePublicIpv4Pools" #(required if publicIpv4Pool is specified in install-config.yaml)
          - "ec2:DescribeRegions"
          - "ec2:DescribeRouteTables"
          - "ec2:DescribeSecurityGroupRules"
          - "ec2:DescribeSecurityGroups"
          - "ec2:DescribeSubnets"
          - "ec2:DescribeTags"
          - "ec2:DescribeVolumes"
          - "ec2:DescribeVpcAttribute"
          - "ec2:DescribeVpcClassicLink"
          - "ec2:DescribeVpcClassicLinkDnsSupport"
          - "ec2:DescribeVpcEndpoints"
          - "ec2:DescribeVpcs"
          #- "ec2:DisassociateAddress" #(required if publicIpv4Pool is specified in install-config.yaml)
          - "ec2:GetEbsDefaultKmsKeyId"
          - "ec2:ModifyInstanceAttribute"
          - "ec2:ModifyNetworkInterfaceAttribute"
          - "ec2:RevokeSecurityGroupEgress"
          - "ec2:RevokeSecurityGroupIngress"
          - "ec2:RunInstances"
          - "ec2:TerminateInstances"
          - "elasticloadbalancing:AddTags"
          - "elasticloadbalancing:ApplySecurityGroupsToLoadBalancer"
          - "elasticloadbalancing:AttachLoadBalancerToSubnets"
          - "elasticloadbalancing:ConfigureHealthCheck"
          - "elasticloadbalancing:CreateListener"
          - "elasticloadbalancing:CreateLoadBalancer"
          - "elasticloadbalancing:CreateLoadBalancerListeners"
          - "elasticloadbalancing:CreateTargetGroup"
          - "elasticloadbalancing:DeleteLoadBalancer"
          - "elasticloadbalancing:DeregisterInstancesFromLoadBalancer"
          - "elasticloadbalancing:DeregisterTargets"
          - "elasticloadbalancing:DescribeInstanceHealth"
          - "elasticloadbalancing:DescribeListeners"
          - "elasticloadbalancing:DescribeLoadBalancerAttributes"
          - "elasticloadbalancing:DescribeLoadBalancers"
          - "elasticloadbalancing:DescribeTags"
          - "elasticloadbalancing:DescribeTargetGroupAttributes"
          - "elasticloadbalancing:DescribeTargetHealth"
          - "elasticloadbalancing:ModifyLoadBalancerAttributes"
          - "elasticloadbalancing:ModifyTargetGroup"
          - "elasticloadbalancing:ModifyTargetGroupAttributes"
          - "elasticloadbalancing:RegisterInstancesWithLoadBalancer"
          - "elasticloadbalancing:RegisterTargets"
          - "elasticloadbalancing:SetLoadBalancerPoliciesOfListener"
          - "elasticloadbalancing:SetSecurityGroups"
          - "iam:AddRoleToInstanceProfile"
          - "iam:CreateInstanceProfile"
          - "iam:CreateRole"
          - "iam:DeleteInstanceProfile"
          - "iam:DeleteRole"
          - "iam:DeleteRolePolicy"
          - "iam:GetInstanceProfile"
          - "iam:GetRole"
          - "iam:GetRolePolicy"
          - "iam:GetUser"
          - "iam:ListInstanceProfilesForRole"
          - "iam:ListRoles"
          - "iam:ListUsers"
          - "iam:PassRole"
          - "iam:PutRolePolicy"
          - "iam:RemoveRoleFromInstanceProfile"
          - "iam:SimulatePrincipalPolicy"
          - "iam:TagInstanceProfile"
          - "iam:TagRole"
          - "iam:CreateServiceLinkedRole"
          - "iam:UntagRole"
          - "tag:UntagResources"
          - "route53:ChangeResourceRecordSets"
          - "route53:ChangeTagsForResource"
          - "route53:CreateHostedZone"
          - "route53:DeleteHostedZone"
          - "route53:GetChange"
          - "route53:GetHostedZone"
          - "route53:ListHostedZones"
          - "route53:ListHostedZonesByName"
          - "route53:ListResourceRecordSets"
          - "route53:ListTagsForResource"
          - "route53:UpdateHostedZoneComment"
          - "s3:CreateBucket"
          - "s3:DeleteBucket"
          - "s3:GetAccelerateConfiguration"
          - "s3:GetBucketAcl"
          - "s3:GetBucketCors"
          - "s3:GetBucketLocation"
          - "s3:GetBucketLogging"
          - "s3:GetBucketObjectLockConfiguration"
          - "s3:GetBucketPolicy"
          - "s3:GetBucketRequestPayment"
          - "s3:GetBucketTagging"
          - "s3:GetBucketVersioning"
          - "s3:GetBucketWebsite"
          - "s3:GetEncryptionConfiguration"
          - "s3:GetLifecycleConfiguration"
          - "s3:GetReplicationConfiguration"
          - "s3:ListBucket"
          - "s3:PutBucketAcl"
          - "s3:PutBucketPolicy"
          - "s3:PutBucketTagging"
          - "s3:PutEncryptionConfiguration"
          - "s3:DeleteObject"
          - "s3:GetObject"
          - "s3:GetObjectAcl"
          - "s3:GetObjectTagging"
          - "s3:GetObjectVersion"
          - "s3:PutObject"
          - "s3:PutObjectAcl"
          - "s3:PutObjectTagging"
          - "autoscaling:DescribeAutoScalingGroups"
          - "ec2:DeleteNetworkInterface"
          - "ec2:DeletePlacementGroup"
          - "ec2:DeleteVolume"
          - "elasticloadbalancing:DeleteTargetGroup"
          - "elasticloadbalancing:DescribeTargetGroups"
          - "iam:DeleteAccessKey"
          - "iam:DeleteUser"
          - "iam:DeleteUserPolicy"
          - "iam:ListAttachedRolePolicies"
          - "iam:ListInstanceProfiles"
          - "iam:ListRolePolicies"
          - "iam:ListUserPolicies"
          - "s3:DeleteObject"
          - "s3:ListBucketVersions"
          - "tag:GetResources"
          Resource: "*"
#      Tags:
#      - Key: "Name"
#        Value: !Join ["-", [!Ref InfrastructureName, "installer", "role"]]

Outputs:
  OpenShiftInstallerIamRole:
    Description: OpenShift Installer IAM Instance Role
    Value: !Ref OpenShiftInstallerIamRole
