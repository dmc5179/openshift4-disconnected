AWSTemplateFormatVersion: 2010-09-09
Description: Template for OpenShift Cluster Runtime user permissions, not install time.

Parameters:
  InfrastructureName:
    AllowedPattern: ^([a-zA-Z][a-zA-Z0-9\-]{0,26})$
    MaxLength: 27
    MinLength: 1
    ConstraintDescription: >-
      Infrastructure name must be alphanumeric, start with a letter, and have a maximum of 27 characters.
    Description: >-
      Prepended to the name of resources created like, openshift4-master-role, openshift4-worker-role
    Type: String
    Default: "openshift4"

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: "Cluster Information"
      Parameters:
      - InfrastructureName
    ParameterLabels:
      InfrastructureName:
        default: "Infrastructure Name"

Resources:

  MyIAMUser:
    Type: AWS::IAM::User
    Properties:
      UserName: OpenShiftRuntime
      # You can optionally attach managed policies directly to the user
      ManagedPolicyArns:
        - !Ref OpenShiftRuntimeIamRole

  OpenShiftRuntimeIamRole:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: "Allow" # machine-api-operator
          Action:
          - "ec2:CreateTags"
          - "ec2:DescribeAvailabilityZones"
          - "ec2:DescribeDhcpOptions"
          - "ec2:DescribeImages"
          - "ec2:DescribeInstances"
          - "ec2:DescribeInstanceTypes"
          - "ec2:DescribeInternetGateways"
          - "ec2:DescribeSecurityGroups"
          - "ec2:DescribeRegions"
          - "ec2:DescribeSubnets"
          - "ec2:DescribeVpcs"
          - "ec2:RunInstances"
          - "ec2:TerminateInstances"
          - "elasticloadbalancing:DescribeLoadBalancers"
          - "elasticloadbalancing:DescribeTargetGroups"
          - "elasticloadbalancing:DescribeTargetHealth"
          - "elasticloadbalancing:RegisterInstancesWithLoadBalancer"
          - "elasticloadbalancing:RegisterTargets"
          - "elasticloadbalancing:DeregisterTargets"
          - "iam:PassRole"
          - "iam:CreateServiceLinkedRole"
          Resource: "*"
        - Effect: "Allow" # machine-api-operator
          Action:
          - "kms:Decrypt"
          - "kms:Encrypt"
          - "kms:GenerateDataKey"
          - "kms:GenerateDataKeyWithoutPlainText"
          - "kms:DescribeKey"
          Resource: "*"
        - Effect: "Allow" # machine-api-operator
          Action:
          - "kms:RevokeGrant"
          - "kms:CreateGrant"
          - "kms:ListGrants"
          Resource: "*"
        - Effect: "Allow" # cloud-credential-operator
          Action:
          - "iam:GetUser"
          - "iam:GetUserPolicy"
          - "iam:ListAccessKeys"
          Resource: "*"
        - Effect: "Allow" # cluster-image-registry-operator
          Action:
          - "s3:CreateBucket"
          - "s3:DeleteBucket"
          - "s3:PutBucketTagging"
          - "s3:GetBucketTagging"
          - "s3:PutBucketPublicAccessBlock"
          - "s3:GetBucketPublicAccessBlock"
          - "s3:PutEncryptionConfiguration"
          - "s3:GetEncryptionConfiguration"
          - "s3:PutLifecycleConfiguration"
          - "s3:GetLifecycleConfiguration"
          - "s3:GetBucketLocation"
          - "s3:ListBucket"
          - "s3:GetObject"
          - "s3:PutObject"
          - "s3:DeleteObject"
          - "s3:ListBucketMultipartUploads"
          - "s3:AbortMultipartUpload"
          - "s3:ListMultipartUploadParts"
          Resource: "*"
        - Effect: "Allow" # cluster-ingress-operator
          Action:
          - "elasticloadbalancing:DescribeLoadBalancers"
          - "route53:ListHostedZones"
          - "route53:ListTagsForResources"
          - "route53:ChangeResourceRecordSets"
          - "tag:GetResources"
          - "sts:AssumeRole"
          Resource: "*"
        - Effect: "Allow" # cluster-network-operator
          Action:
          - "ec2:DescribeInstances"
          - "ec2:DescribeInstanceStatus"
          - "ec2:DescribeInstanceTypes"
          - "ec2:UnassignPrivateIpAddresses"
          - "ec2:AssignPrivateIpAddresses"
          - "ec2:UnassignIpv6Addresses"
          - "ec2:AssignIpv6Addresses"
          - "ec2:DescribeSubnets"
          - "ec2:DescribeNetworkInterfaces"
          Resource: "*"
        - Effect: "Allow" # cluster-storage-operator
          Action:
          - "ec2:AttachVolume"
          - "ec2:CreateSnapshot"
          - "ec2:CreateTags"
          - "ec2:CreateVolume"
          - "ec2:DeleteSnapshot"
          - "ec2:DeleteTags"
          - "ec2:DeleteVolume"
          - "ec2:DescribeInstances"
          - "ec2:DescribeSnapshots"
          - "ec2:DescribeTags"
          - "ec2:DescribeVolumes"
          - "ec2:DescribeVolumesModifications"
          - "ec2:DetachVolume"
          - "ec2:ModifyVolume"
          - "ec2:DescribeAvailabilityZones"
          - "ec2:EnableFastSnapshotRestores"
          Resource: "*"
        - Effect: "Allow" # cluster-storage-operator
          Action:
          - "kms:ReEncrypt*"
          - "kms:Decrypt"
          - "kms:Encrypt"
          - "kms:GenerateDataKey"
          - "kms:GenerateDataKeyWithoutPlainText"
          - "kms:DescribeKey"
          Resource: "*"
        - Effect: "Allow" # cluster-storage-operator
          Action:
          - "kms:RevokeGrant"
          - "kms:CreateGrant"
          - "kms:ListGrants"
          Resource: "*"

Outputs:
  OpenShiftRuntimeIamRole:
    Description: OpenShift Runtime IAM User and Policy
    Value: !Ref OpenShiftRuntimeIamRole
