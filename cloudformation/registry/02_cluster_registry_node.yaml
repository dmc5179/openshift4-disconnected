AWSTemplateFormatVersion: 2010-09-09
Description: Template for OpenShift Cluster Disconnected Registry

Parameters:
  InfrastructureName:
    AllowedPattern: ^([a-zA-Z][a-zA-Z0-9\-]{0,26})$
    MaxLength: 27
    MinLength: 1
    ConstraintDescription: Infrastructure name must be alphanumeric, start with a letter, and have a maximum of 27 characters.
    Description: A short, unique cluster ID used to tag nodes for the kubelet cloud provider.
    Type: String
  RhelAmi:
    Description: Current Red Hat Enterprise Linux CoreOS AMI to use for bootstrap.
    Type: AWS::EC2::Image::Id
  Subnet:
    Description: The subnets, recommend private, to launch the master nodes into.
    Type: AWS::EC2::Subnet::Id
  RegistrySecurityGroupId:
    Description: The master security group ID to associate with master nodes.
    Type: AWS::EC2::SecurityGroup::Id
  RegistryInstanceProfileName:
    Description: IAM profile to associate with master nodes.
    Type: String
  RegistryInstanceType:
    Default: m4.large
    Type: String
    AllowedValues:
    - "m4.large"
    - "m4.xlarge"
    - "m4.2xlarge"
    - "c4.large"
    - "c4.xlarge"
    - "c4.2xlarge"
    - "r4.large"
    - "r4.xlarge"
    - "r4.2xlarge"

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: "Cluster Information"
      Parameters:
      - InfrastructureName
    - Label:
        default: "Host Information"
      Parameters:
      - RegistryInstanceType
      - RhelAmi
      - RegistrySecurityGroupId
      - RegistryInstanceProfileName
    - Label:
        default: "Network Configuration"
      Parameters:
      - Subnet
    ParameterLabels:
      Subnet:
        default: "Subnet"
      InfrastructureName:
        default: "Infrastructure Name"
      RegistryInstanceType:
        default: "Registry Instance Type"
      RegistryInstanceProfileName:
        default: "Registry Instance Profile Name"
      RhelAmi:
        default: "Red Hat Enterprise Linux AMI ID"
      RegistrySecurityGroupId:
        default: "Registry Security Group ID"

Resources:
  Registry:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref RhelAmi
      BlockDeviceMappings:
      - DeviceName: /dev/xvda
        Ebs:
          VolumeSize: "120"
          VolumeType: "gp2"
      IamInstanceProfile: !Ref RegistryInstanceProfileName
      InstanceType: !Ref RegistryInstanceType
      NetworkInterfaces:
      - AssociatePublicIpAddress: "false"
        DeviceIndex: "0"
        GroupSet:
        - !Ref "RegistrySecurityGroupId"
        SubnetId: !Ref "Subnet"
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # TODO: Pull down the scripts to install the registry
          # TODO: Pull down the scripts to start the registry and import images

      Tags:
      - Key: !Join ["", ["kubernetes.io/cluster/", !Ref InfrastructureName]]
        Value: "shared"

Outputs:
  PrivateIP:
    Description: The registry node private IP address.
    Value: !GetAtt Registry.PrivateIp
