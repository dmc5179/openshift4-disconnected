---
AWSTemplateFormatVersion: 2010-09-09

Description: Calls Sub Templates to deploy the registry node # TODO wait handlers to ensure proper start up

Metadata:
    AWS::CloudFormation::Interface:
        ParameterGroups:
            - Label:
                default: Creation Configuration
              Parameters:
                - Owner
                - Classification
                - PartitionName

Parameters:
  AmiId:
    Default: ami-
    Description: Custom Redhat Linux AMI with AWS CLI and Partitions
    Type: AWS::EC2::Image::Id

  AnsibleInstanceType: #Openshift
    Default: m5.xlarge
    Description: Instance type of the Registry EC2 Instance
    Type: String

Mappings:
  ClassificationMap:
      "Unclassified":
        ClassificationText: "UNCLASSIFIED"
        ClassificationScript: unclassified.js
        ClassificationColor: "#5cb85c"
      "Confidential":
        ClassificationText: "CONFIDENTIAL"
        ClassificationScript: confidential.js
        ClassificationColor: "#286090"
      "Secret":
        ClassificationText: "SECRET"
        ClassificationScript: secret.js
        ClassificationColor: "#d9534f"
      "TopSecret":
        ClassificationText: "TOP SECRET"
        ClassificationScript: topsecret.js
        ClassificationColor: "#f0ad4e"

Conditions:
  CreateIAMResources: !Equals [ !Ref CreateIAMStack, true ]
  CreateDNSResources: !Equals [ !Ref EnableDNS, true ]
  CreateAlarmResources: !Equals [ !Ref EnableAlarms, true ]
  CreateStorageResources: !Not [ !Equals [!Ref NumberOfComputeStorages, 0]]
  CreateStorageCloudwatch: !And
  - !Condition CreateAlarmResources
  - !Condition CreateStorageResources
  CreateGPUResources: !Not [ !Equals  [!Ref NumberOfGPU, 0 ]]

Resources:

# CF Stacks that need to be run
# 01_registry_security_groups.yaml
# 02_cluster_registry_node.yaml

  RegistrySecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${S3ServiceName}/${S3ArtifactsPath}/openshift4-disconnected/cloudformation/open-shift-security-groups.yml'
      Parameters:
        StackName: !Ref AWS::StackName
        VpcId: !Ref VpcId
        VpcCIDR: !Ref VpcCIDR

