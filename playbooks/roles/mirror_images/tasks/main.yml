---
# tasks file for mirror_images

- name: Install skopeo
  become: true
  package:
    name: skopeo
    state: present

- name: Create additional image directory
  become: true
  file:
    path: "{{ mirror_base }}/additional_images"
    state: directory

# Must contain tokens for both OCP image registry
# and the mirror registry
- name: Stage pull secret
  become: true
  copy:
    src: "{{ local_pull_secret }}"
    dest: "{{ pull_secret }}"
    owner: root
    group: root
    mode: '0755'

- name: Mirror additional container images
  become: true
  shell:
    cmd: |

        if ! test -e "{{ mirror_base }}/additional_images/{{ ( item | replace(':','_') | replace('/','-') ) }}.tar"
        then
          skopeo copy --authfile "{{ pull_secret }}" \
            "docker://{{ item }}" "docker-archive://{{ mirror_base }}/additional_images/{{ ( item | replace(':','_') | replace('/','-') ) }}.tar"
        fi

    executable: /bin/bash
  with_items:
    - "{{ images }}"

- name: Include list of Ansible Tower Images
  include_vars: tower.yml
  when:
    - (mirror_tower | bool)

- name: Mirror Ansible Tower images
  become: true
  shell:
    cmd: |

        if ! test -e  "{{ mirror_base }}/additional_images/{{ ( item | replace(':','_') | replace('/','-') ) }}.tar"
        then
          skopeo copy --authfile "{{ pull_secret }}" \
            "docker://{{ item }}" "docker-archive://{{ mirror_base }}/additional_images/{{ ( item | replace(':','_') | replace('/','-') ) }}.tar"
        fi

    executable: /bin/bash
  with_items:
    - "{{ tower_images }}"
  when:
    - (mirror_tower | bool)

- name: Include list of Compliance Operator Images
  include_vars: compliance_operator.yml
  when:
    - (mirror_compliance_operator | bool)

- name: Mirror Compliance Operator images
  become: true
  shell:
    cmd: |

        if ! test -e  "{{ mirror_base }}/additional_images/{{ ( item | replace(':','_') | replace('/','-') ) }}.tar"
        then 
          skopeo copy --authfile "{{ pull_secret }}" \
            "docker://{{ item }}" "docker-archive://{{ mirror_base }}/additional_images/{{ ( item | replace(':','_') | replace('/','-') ) }}.tar"
        fi

    executable: /bin/bash
  with_items:
    - "{{ compliance_operator_images }}"
  when:
    - (mirror_compliance_operator | bool)
