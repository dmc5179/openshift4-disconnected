---
# tasks file for generate_ignition

- name: Remove existing ignition configs
  file:
    path: "{{ ignition_configs }}"
    state: absent

- name: Create ignition configs directory
  file:
    path: "{{ ignition_configs }}"
    state: directory
    mode: '0755'

- name: Fetch public key
  slurp:
    src: "{{ ssh_public_key_file }}"
  register: slurped_key_b64

- name: Fetch pull secret
  slurp:
    src: "{{ pull_secret }}"
  register: slurped_pull_secret_b64

- name: Fetch CA Bundle
  slurp:
    src: "{{ certificate_bundle }}"
  register: slurped_ca_bundle_b64

- name: Copy template install-config.yaml
  template:
    src: install-config.yaml.j2
    dest: "{{ ignition_configs }}/install-config.yaml"
    mode: 0664

- name: Ensure proper spacing of additionalTrustBundle
  shell:
    cmd: awk -i inplace 'BEGIN{c=0}  /BEGIN CERTIFICATE/{c=1}  {if (c==1) print " ",$0}  {if (c==0) print $0}  /END CERTIFICATE/{c=0}' "{{ ignition_configs }}/install-config.yaml"

- name: Create manifests
  shell: "{{ openshift_install }} create manifests --dir={{ ignition_configs }}"
#  creates: "{{ ignition_configs }}/manifests/cluster-config.yaml"

- name: Set masters to unschedulable
  replace:
    path: "{{ ignition_configs }}/manifests/cluster-scheduler-02-config.yml"
    regexp: 'mastersSchedulable: true'
    replace: 'mastersSchedulable: false'

- name: Set cluster upgrade channel
  replace:
    path: "{{ ignition_configs }}/manifests/cvo-overrides.yaml"
    regexp: 'channel:.*'
    replace: 'channel: {{ cluster_channel }}'

# Prevent the cluster from trying to reach the Cincinnati for update graphs
- name: Set dummy Cincinnati server
  replace:
    path: "{{ ignition_configs }}/manifests/cvo-overrides.yaml"
    regexp: 'upstream:.*'
    replace: 'upstream: http://localhost:8080/graph'

- name: Add vCenter port to global cloud provider config
  lineinfile:
    path: "{{ ignition_configs }}/manifests/cloud-provider-config.yaml"
    insertafter: '\[Global\]'
    line: '    port = "{{ vcenter_port }}"'
  when:
    - (platform is match("vmware"))

- name: Add vCenter port to VirtualCenter cloud provider config
  lineinfile:
    path: "{{ ignition_configs }}/manifests/cloud-provider-config.yaml"
    insertafter: '\[VirtualCenter.*\]'
    line: '    report = "{{ vcenter_port }}"'
  when:
    - (platform is match("vmware"))

- name: Disable SSL for vCenter API endpoint
  lineinfile:
    path: "{{ ignition_configs }}/manifests/cloud-provider-config.yaml"
    regexp: 'insecure-flag = "1"'
    line: '    insecure-flag = "true"'
  when:
    - (platform is match("vmware"))

- name: Fix line due to ansible bug
  lineinfile:
    path: "{{ ignition_configs }}/manifests/cloud-provider-config.yaml"
    regexp: 'report = \"{{ vcenter_port }}\"'
    line: '    port = "{{ vcenter_port }}"'
  when:
    - (platform is match("vmware"))

- name: Create ignition configs
  shell: "{{ openshift_install }} create ignition-configs --dir={{ ignition_configs }}"

- name: Create kube config location
  file:
    path: "~/.kube"
    state: directory
    mode: '0755'

- name: Set kube config
  copy:
    src: "{{ ignition_configs }}/auth/kubeconfig"
    dest: "~/.kube/config"
