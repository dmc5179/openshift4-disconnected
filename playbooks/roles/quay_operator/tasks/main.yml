---

- name: Create quay namespace
  delegate_to: localhost
  k8s:
    name: '{{ quay_namespace }}'
    api_version: v1
    kind: Namespace
    state: present
    wait: true
    kubeconfig: "{{ kubeconfig  }}"
    validate_certs: '{{ kube_ssl_enabled }}'

- name: Subscribe to the quay operator
  delegate_to: localhost
  k8s:
    state: present
    namespace: '{{ quay_namespace }}'
    wait: true
    kubeconfig: "{{ kubeconfig }}"
    validate_certs: '{{ kube_ssl_enabled }}'
    definition: "{{ lookup('template', 'templates/quay-operator.yaml.j2') }}"

- name: Slurp the pull secret file into a variable
  delegate_to: localhost
  slurp:
    src: "{{ pull_secret }}"
  register: pull_secret_slurp

- name: Create Redhat pull secret
  delegate_to: localhost
  k8s:
    state: present
    name: 'redhat-pull-secret'
    namespace: '{{ quay_namespace }}'
    wait: true
    kubeconfig: "{{ kubeconfig }}"
    validate_certs: '{{ kube_ssl_enabled }}'
    definition: "{{ lookup('template', 'templates/redhat_pull_secret.yaml.j2') }}"

- name: Create Quay EcoSystem
  delegate_to: localhost
  k8s:
    state: present
    namespace: '{{ quay_namespace }}'
    wait: true
    kubeconfig: "{{ kubeconfig }}"
    validate_certs: '{{ kube_ssl_enabled }}'
    definition: "{{ lookup('template', 'templates/quay-ecosystem.yaml.j2') }}"
