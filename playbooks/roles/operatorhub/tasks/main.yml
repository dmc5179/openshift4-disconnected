---
# tasks file for operatorhub

- name: Create redhat-operators catalog image
  become: "{{ run_as_root }}"
  shell:
    cmd: "{{ oc }} adm catalog build --insecure --appregistry-org redhat-operators --to={{ rh_op_repo }} --from={{ operator_registry }} --registry-config={{ pull_secret }}"
    executable: /bin/bash
  when: (redhat_operators | bool)
  tags:
    - mirror

- name: Mirror redhat-operators images
  become: "{{ run_as_root }}"
  shell:
    cmd: "{{ oc }} adm catalog mirror {{ rh_op_repo }} {{ mirror_registry }} -a {{ pull_secret }} --insecure"
    executable: /bin/bash
  when: (redhat_operators | bool)
  tags:
    - mirror

- name: Create certified-operators catalog image
  become: "{{ run_as_root }}"
  shell:
    cmd: "{{ oc }} adm catalog build --appregistry-org certified-operators --to={{ supp_op_repo }} --from={{ operator_registry }} --registry-config={{ pull_secret }}"
    executable: /bin/bash
  when: (supported_operators | bool)
  tags:
    - mirror

- name: Mirror certified-operators images
  become: "{{ run_as_root }}"
  shell:
    cmd: "{{ oc }} adm catalog mirror {{ supp_op_repo }} {{ mirror_registry }} -a {{ pull_secret }} --insecure"
    executable: /bin/bash
  when: (supported_operators | bool)
  tags:
    - mirror

- name: Create community-operators catalog image
  become: "{{ run_as_root }}"
  shell:
    cmd: "{{ oc }} adm catalog build --appregistry-org community-operators --to={{ comm_op_repo }} --from={{ operator_registry }} --registry-config={{ pull_secret }}"
    executable: /bin/bash
  when: (community_operators | bool)
  tags:
    - mirror

- name: Mirror community-operators images
  become: "{{ run_as_root }}"
  shell:
    cmd: "{{ oc }} adm catalog mirror {{ comm_op_repo }} {{ mirror_registry }} -a {{ pull_secret }} --insecure"
    executable: /bin/bash
  when: (community_operators | bool)
  tags:
    - mirror

- name: Disable connected version of OperatorHub
  shell:
    cmd: "{{ oc }} patch OperatorHub cluster --type json -p '{{ patch_json }}'"
  tags:
    - install

- name: Deploy redhat-operators catalog source
  delegate_to: localhost
  k8s:
    state: present
    wait: true
    kubeconfig: "{{ kubeconfig }}"
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        name: redhat-operator-catalog
        namespace: openshift-marketplace
      spec:
        sourceType: grpc
        image: '{{ mirror_registry }}/olm/redhat-operators:v1'
        displayName: RedHat Operators Catalog
        publisher: grpc
  tags:
    - install

- name: Deploy certified-operators catalog source
  delegate_to: localhost
  k8s:
    state: present
    wait: true
    kubeconfig: "{{ kubeconfig }}"
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        name: certified-operator-catalog
        namespace: openshift-marketplace
      spec:
        sourceType: grpc
        image: '{{ mirror_registry }}/olm/certified-operators:v1'
        displayName: Certified Operators Catalog
        publisher: grpc
  tags:
    - install

- name: Deploy community-operators catalog source
  delegate_to: localhost
  k8s:
    state: present
    wait: true
    kubeconfig: "{{ kubeconfig }}"
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        name: community-operator-catalog
        namespace: openshift-marketplace
      spec:
        sourceType: grpc
        image: '{{ mirror_registry }}/olm/community-operators:v1'
        displayName: Community Operators Catalog
        publisher: grpc
  tags:
    - install

- name: Uninstall redhat-operators catalog source
  delegate_to: localhost
  k8s:
    state: absent
    wait: true
    kubeconfig: "{{ kubeconfig }}"
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        name: redhat-operator-catalog
        namespace: openshift-marketplace
      spec:
        sourceType: grpc
        image: '{{ mirror_registry }}/olm/redhat-operators:v1'
        displayName: RedHat Operators Catalog
        publisher: grpc
  tags:
    - uninstall

- name: Uninstall certified-operators catalog source
  delegate_to: localhost
  k8s:
    state: absent
    wait: true
    kubeconfig: "{{ kubeconfig }}"
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        name: certified-operator-catalog
        namespace: openshift-marketplace
      spec:
        sourceType: grpc
        image: '{{ mirror_registry }}/olm/certified-operators:v1'
        displayName: Certified Operators Catalog
        publisher: grpc
  tags:
    - uninstall

- name: Uninstall community-operators catalog source
  delegate_to: localhost
  k8s:
    state: absent
    wait: true
    kubeconfig: "{{ kubeconfig }}"
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        name: community-operator-catalog
        namespace: openshift-marketplace
      spec:
        sourceType: grpc
        image: '{{ mirror_registry }}/olm/community-operators:v1'
        displayName: Community Operators Catalog
        publisher: grpc
  tags:
    - uninstall
