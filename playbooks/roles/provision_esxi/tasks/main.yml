---
# tasks file for provision_esxi

- name: Install required pip packages
  delegate_to: localhost
  pip:
    name:
      - PyVmomi
      - pyVim
    extra_args: --user
    executable: pip3

- name: Create a VM folder on given datacenter
  vcenter_folder:
    hostname: '{{ vcenter_hostname }}'
    port: '{{ vcenter_port }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    datacenter_name: '{{ datacenter_name }}'
    folder_name: 'caas'
    folder_type: vm
    state: present
    validate_certs: "{{ ssl_enabled }}"
  register: vm_folder_creation_result
  delegate_to: localhost

- name: Copy RHCOS OVA to Datastore
  vsphere_copy:
    hostname: '{{ vcenter_hostname }}'
    port: '{{ vcenter_port }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    src: '{{ mirror_base }}/rhcos/rhcos-{{ rhcos_ver }}-{{ arch }}-vmware.{{ arch }}.ova'
    datacenter: '{{ datacenter_name }}'
    datastore: '{{ datastore_name }}'
    path: 'caas/rhcos-{{ rhcos_ver }}-{{ arch }}-vmware.{{ arch }}.ova'
    validate_certs: "{{ ssl_enabled }}"
  delegate_to: localhost
  when: (upload_ova | bool)

# TODO: OVA Template cannot be used with static IPs
#       This is a known issue
#- name: Include Tasks to create template
#  include_tasks: create_template.yml

#- name: Include tasks to create networks
#  include_tasks: create_network.yml

- name: Include tasks to create nodes
  include_tasks: create_nodes.yml
